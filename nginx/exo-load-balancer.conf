# Nginx Load Balancer for exo-rkllama
#
# Distributes requests across multiple RK3588 nodes for request-level parallelism.
# RKLLM can't do layer sharding, so this provides horizontal scaling instead.
#
# Usage:
#   sudo cp exo-load-balancer.conf /etc/nginx/sites-available/exo
#   sudo ln -s /etc/nginx/sites-available/exo /etc/nginx/sites-enabled/
#   sudo nginx -t && sudo systemctl reload nginx

# Upstream pool of exo nodes
upstream exo_cluster {
    # Load balancing method (choose one):
    # - Round-robin (default): Distributes requests evenly
    # - least_conn: Sends to node with fewest active connections
    # - ip_hash: Sticky sessions based on client IP
    least_conn;

    # RK3588 nodes running exo
    # Adjust hostnames/IPs to match your setup
    server rk3588-node1:52415 weight=1 max_fails=3 fail_timeout=30s;
    server rk3588-node2:52415 weight=1 max_fails=3 fail_timeout=30s;
    server rk3588-node3:52415 weight=1 max_fails=3 fail_timeout=30s;
    # server rk3588-node4:52415 weight=1 max_fails=3 fail_timeout=30s;

    # Health check interval (requires nginx plus or lua module for active checks)
    # Passive health checks are enabled via max_fails/fail_timeout above

    # Keep connections alive to backend
    keepalive 32;
}

# Optional: Separate upstream for metrics scraping
upstream exo_metrics {
    server rk3588-node1:52415;
    server rk3588-node2:52415;
    server rk3588-node3:52415;
}

# Main load balancer server
server {
    listen 80;
    listen [::]:80;
    server_name exo.local exo.example.com;

    # Redirect HTTP to HTTPS (uncomment if using SSL)
    # return 301 https://$server_name$request_uri;

    # Access log with upstream info
    log_format exo_lb '$remote_addr - $remote_user [$time_local] '
                      '"$request" $status $body_bytes_sent '
                      '"$http_referer" "$http_user_agent" '
                      'upstream=$upstream_addr response_time=$upstream_response_time';
    access_log /var/log/nginx/exo-access.log exo_lb;
    error_log /var/log/nginx/exo-error.log;

    # ChatGPT-compatible API endpoint
    location /v1/ {
        proxy_pass http://exo_cluster;
        proxy_http_version 1.1;

        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeouts (LLM inference can be slow)
        proxy_connect_timeout 10s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;

        # Buffering settings for streaming responses
        proxy_buffering off;
        proxy_cache off;

        # SSE/streaming support
        proxy_set_header Connection '';
        chunked_transfer_encoding on;

        # Retry on failure (optional)
        proxy_next_upstream error timeout http_502 http_503 http_504;
        proxy_next_upstream_tries 2;
    }

    # Health check endpoint
    location /healthcheck {
        proxy_pass http://exo_cluster;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_connect_timeout 5s;
        proxy_read_timeout 5s;
    }

    # Web UI (tinychat)
    location / {
        proxy_pass http://exo_cluster;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # Prometheus metrics - aggregate from all nodes
    # Access individual nodes: /metrics/node1, /metrics/node2, etc.
    location /metrics {
        # Return metrics from first available node
        proxy_pass http://exo_cluster;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_connect_timeout 5s;
        proxy_read_timeout 10s;
    }

    # Optional: Basic auth for API protection
    # auth_basic "Exo API";
    # auth_basic_user_file /etc/nginx/.htpasswd;
}

# HTTPS server (uncomment and configure for production)
# server {
#     listen 443 ssl http2;
#     listen [::]:443 ssl http2;
#     server_name exo.example.com;
#
#     ssl_certificate /etc/letsencrypt/live/exo.example.com/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/exo.example.com/privkey.pem;
#     ssl_session_timeout 1d;
#     ssl_session_cache shared:SSL:50m;
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
#     ssl_prefer_server_ciphers off;
#
#     # HSTS
#     add_header Strict-Transport-Security "max-age=63072000" always;
#
#     # Include same location blocks as HTTP server above
#     location /v1/ {
#         proxy_pass http://exo_cluster;
#         # ... same settings as above
#     }
# }

# Status page for monitoring (optional)
server {
    listen 8080;
    listen [::]:8080;
    server_name localhost;

    # Only allow local access
    allow 127.0.0.1;
    allow ::1;
    deny all;

    location /nginx_status {
        stub_status on;
    }

    # Upstream health status (requires nginx plus)
    # location /upstream_status {
    #     upstream_conf;
    # }
}
